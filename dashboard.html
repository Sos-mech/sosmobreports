<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOS Mechanics Scanner Dashboard</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:0;}
header{background:#222;color:#fff;padding:15px;text-align:center;position:fixed;top:0;width:100%;z-index:1000;}
.container{max-width:800px;margin:80px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label{display:block;margin-bottom:5px;font-weight:bold;}
select,input{width:100%;padding:12px;margin-bottom:15px;border-radius:6px;border:1px solid #ccc;font-size:1em;}
.btn{display:block;width:100%;padding:15px;margin:10px 0;border:none;border-radius:8px;font-weight:bold;font-size:1.1em;cursor:pointer;}
.btn-primary{background:#4CAF50;color:white;}
.btn-primary:hover{background:#45a049;}
iframe{width:100%;height:500px;border:1px solid #ccc;border-radius:6px;margin-top:20px;}
.hidden{display:none;}
.highlight{background:#ffff99;}
</style>
</head>
<body>

<header>
<h1>SOS Mechanics Scanner Dashboard</h1>
</header>

<div class="container">

<h2>Open Report / Page</h2>

<label>Select HTML Page:</label>
<select id="pageSelect">
  <option value="">-- Loading pages --</option>
</select>

<button class="btn btn-primary" onclick="loadPage()">Open Page</button>

<h2>Scan Customer QR</h2>
<input type="file" id="qrUpload" accept="image/*">
<canvas id="qrCanvas" class="hidden"></canvas>

<iframe id="reportFrame" class="hidden"></iframe>

</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>

let lastFiles = [];

// ---------- Fetch JSON and update dropdown ----------
function updateDropdown(){
  fetch('files.json')
    .then(res => res.json())
    .then(files => {
      const select = document.getElementById('pageSelect');
      const prevOptions = Array.from(select.options).map(o => o.value);
      select.innerHTML = '<option value="">-- Select a Page --</option>'; // reset

      files.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        if(!lastFiles.includes(f)){
          // Highlight new files
          opt.classList.add('highlight');
        }
        select.appendChild(opt);
      });

      lastFiles = files; // remember last state
    })
    .catch(err => console.error('Error fetching files.json', err));
}

// Initial load
updateDropdown();
// Update every 30 seconds
setInterval(updateDropdown, 30000);

// ---------- Load Selected Page ----------
function loadPage(){
  const val=document.getElementById('pageSelect').value;
  if(!val){alert("Select a page first"); return;}
  const iframe=document.getElementById('reportFrame');
  iframe.src=val;
  iframe.classList.remove('hidden');
}

// ---------- QR Scan ----------
document.getElementById('qrUpload').addEventListener('change', function(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(){
    const img=new Image();
    img.onload=function(){
      const canvas=document.getElementById('qrCanvas');
      canvas.width=img.width; canvas.height=img.height;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(imageData.data, canvas.width, canvas.height);
      if(code){
        alert("QR Decoded: "+code.data);
      } else {
        alert("No QR code detected");
      }
    }
    img.src=reader.result;
  }
  reader.readAsDataURL(file);
});

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOS Mechanics - Pre-Diagnosis</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif;}
body { background:#f5f5f5; }
header { position: fixed; top:0; left:0; right:0; background:#222; color:#fff; padding:15px 20px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:1000;}
header h1 { margin:0; font-size:1.5em; font-weight:600;}
.ticker { margin-top:70px; background:#eaeaea; color:#333; padding:8px 20px; border-bottom:1px solid #ccc; overflow:hidden; white-space:nowrap; font-size:0.9em; border-radius:0 0 6px 6px;}
.ticker span { display:inline-block; padding-right:50px; animation:scroll 15s linear infinite;}
@keyframes scroll { 0% { transform:translateX(100%);} 100% { transform:translateX(-100%);} }

.container { max-width:600px; margin:30px auto 40px; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label { display:block; font-weight:bold; margin-bottom:5px;}
input, textarea, select { width:100%; padding:12px; margin-bottom:20px; border-radius:6px; border:1px solid #ccc; font-size:1em;}
textarea { resize:vertical;}
.btn { display:block; width:100%; padding:15px; margin:10px 0; font-size:1.1em; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
.btn-primary { background:#4CAF50; color:white;}
.btn-primary:hover { background:#45a049;}
.btn-secondary { background:#aaa; color:white;}
.btn-secondary:hover { background:#888;}
.btn-danger { background:#f44336; color:white;}
.btn-danger:hover { background:#d32f2f;}
.hidden { display:none; }

#qr-menu { text-align:center; margin:20px 0; padding:15px; background:#f0f0f0; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1);}
#qrcode { margin-top:20px; text-align:center;}
</style>
</head>
<body>

<header>
  <h1>SOS Mechanics - Pre-Diagnosis</h1>
</header>

<div class="ticker"><span>High-Value Service: Brake Check • Oil Change • Battery Health • Emergency Assistance •</span></div>

<!-- Start Screen -->
<div class="container" id="start-screen">
  <label for="reportSelect">Previous Reports</label>
  <select id="reportSelect">
    <option value="">-- Select Previous Report --</option>
  </select>

  <button class="btn btn-primary" onclick="showInput('manual')">Enter Number Plate</button>
  <button class="btn btn-secondary" onclick="showQRMenu()">Scan QR Code</button>
</div>

<!-- Input Screen -->
<div class="container hidden" id="input-screen">
  <div id="manualEntry" class="hidden">
    <label for="regInput">Number Plate</label>
    <input type="text" id="regInput" placeholder="Enter registration">
    <button class="btn btn-primary" onclick="populateFromReg()">Autofill</button>
  </div>
  <div id="qrEntry" class="hidden" id="qr-menu">
    <p>Choose how to input details:</p>
    <button class="btn btn-primary" onclick="uploadQR()">Upload QR Image</button>
    <button class="btn btn-secondary" onclick="manualFallback()">Type Number Plate</button>
    <button class="btn btn-danger" onclick="closeQRMenu()">Cancel</button>
  </div>
</div>

<!-- Form Screen -->
<div class="container hidden" id="form-screen">
  <label for="customerName">Customer Name</label>
  <input type="text" id="customerName" placeholder="Your name">
  <label for="phone">Phone</label>
  <input type="text" id="phone" placeholder="Phone number">
  <label for="vehicle">Vehicle Make / Model / Year</label>
  <input type="text" id="vehicle">
  <label for="reg">Vehicle Registration</label>
  <input type="text" id="reg">
  <label for="mileage">Mileage</label>
  <input type="text" id="mileage">
  <label for="symptom">Reported Symptom</label>
  <textarea id="symptom" rows="3"></textarea>
  <label for="notes">Additional Notes</label>
  <textarea id="notes" rows="3"></textarea>

  <button class="btn btn-primary" onclick="submitReport()">Confirm & Generate PDF</button>
  <button class="btn btn-secondary" onclick="editForm()">Edit Details</button>
  <button class="btn btn-danger" onclick="resetForm()">Reset Form</button>

  <div id="downloadSection" class="hidden">
    <p>QR scanned successfully! Download your pre-diagnosis report:</p>
    <button class="btn btn-primary" id="downloadPDFBtn">Download PDF</button>
  </div>

  <div id="qrcode"></div>
</div>

<script type="module" src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let previousReports = JSON.parse(localStorage.getItem('reports')||'[]');

function populateDropdown() {
  const select = document.getElementById('reportSelect');
  select.innerHTML = '<option value="">-- Select Previous Report --</option>';
  previousReports.forEach((r,i)=>{
    select.innerHTML += `<option value="${i}">${r.timestamp} - ${r.registration}</option>`;
  });
}
populateDropdown();

document.getElementById('reportSelect').addEventListener('change', function() {
  const idx = this.value;
  if(idx!==''){
    fillForm(previousReports[idx]);
    showScreen('form-screen');
  }
});

function showScreen(id){
  ['start-screen','input-screen','form-screen'].forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function showInput(type){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('input-screen').classList.remove('hidden');
  if(type==='manual'){ document.getElementById('manualEntry').classList.remove('hidden'); }
  if(type==='qr'){ showQRMenu(); }
}

function showQRMenu(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('input-screen').classList.remove('hidden');
  document.getElementById('qrEntry').classList.remove('hidden');
  document.getElementById('manualEntry').classList.add('hidden');
}

function closeQRMenu(){ document.getElementById('input-screen').classList.add('hidden'); showScreen('start-screen'); }

function populateFromReg(){
  const reg = document.getElementById('regInput').value.trim();
  if(!reg) return alert('Enter registration');
  fillForm({customerName:'John Doe', phone:'+44 7000 000000', vehicle:'BMW 1 Series F20 2015', registration:reg, mileage:'109,403 mi', symptom:'Engine issue', notes:''});
  showScreen('form-screen');
  document.getElementById('downloadSection').classList.remove('hidden');
  document.getElementById('downloadPDFBtn').onclick = () => generatePDF({
    customerName:'John Doe', phone:'+44 7000 000000', vehicle:'BMW 1 Series F20 2015', registration:reg, mileage:'109,403 mi', symptom:'Engine issue', notes:''
  });
}

function manualFallback(){ document.getElementById('manualEntry').classList.remove('hidden'); document.getElementById('qrEntry').classList.add('hidden'); }

async function uploadQR(){
  const fileInput = document.createElement('input');
  fileInput.type='file'; fileInput.accept='image/*';
  fileInput.onchange = async e=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const result = await QrScanner.scanImage(file);
      const data = JSON.parse(result); // QR must contain JSON
      fillForm(data);
      showScreen('form-screen');
      const downloadSection = document.getElementById('downloadSection');
      downloadSection.classList.remove('hidden');
      document.getElementById('downloadPDFBtn').onclick = () => generatePDF(data);
    }catch(err){
      alert("QR decode failed. Please enter registration manually.");
      manualFallback();
    }
  };
  fileInput.click();
}

function fillForm(data){
  document.getElementById('customerName').value=data.customerName||'';
  document.getElementById('phone').value=data.phone||'';
  document.getElementById('vehicle').value=data.vehicle||'';
  document.getElementById('reg').value=data.registration||'';
  document.getElementById('mileage').value=data.mileage||'';
  document.getElementById('symptom').value=data.symptom||'';
  document.getElementById('notes').value=data.notes||'';
}

function editForm(){ showScreen('form-screen'); }
function resetForm(){ fillForm({}); document.getElementById('downloadSection').classList.add('hidden'); }

function submitReport(){
  const report = {
    customerName:document.getElementById('customerName').value,
    phone:document.getElementById('phone').value,
    vehicle:document.getElementById('vehicle').value,
    registration:document.getElementById('reg').value,
    mileage:document.getElementById('mileage').value,
    symptom:document.getElementById('symptom').value,
    notes:document.getElementById('notes').value,
    timestamp:new Date().toLocaleString()
  };
  previousReports.push(report);
  localStorage.setItem('reports', JSON.stringify(previousReports));
  populateDropdown();
  generatePDF(report);
}

function generatePDF(report){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=30;
  const now = new Date();
  doc.setFontSize(18);
  doc.text("SOS Mechanics - Pre-Diagnosis", 105, 20, null, null, "center");

  function addField(label, value){
    doc.setFont(undefined,'bold');
    doc.text(label, 15, y);
    y += 8;
    doc.setFont(undefined,'normal');
    doc.text(String(value||"-"), 15, y);
    y += 15;
  }

  addField("Customer Name", report.customerName);
  addField("Phone", report.phone);
  addField("Vehicle Make / Model / Year", report.vehicle);
  addField("Registration", report.registration);
  addField("Mileage", report.mileage);
  addField("Reported Symptom", report.symptom);
  addField("Notes / Observations", report.notes);

  y += 15; 
  doc.text("Mechanic Signature: _______________________", 15, y);

  const footerTimestamp = now.toLocaleString();
  doc.setFontSize(10);
  doc.text(`Report generated: ${footerTimestamp}`, 105, 290, null, null, "center");

  const fileSafeTime = now.toISOString().replace(/[:]/g,'-');
  const pdfName = `${report.registration || 'vehicle'}_${fileSafeTime}_PreDiagnosis.pdf`;
  doc.save(pdfName);
}
</script>
</body>
</html>